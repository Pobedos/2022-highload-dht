## Stage 3

### Put

`wrk2 -c 64 -d 1m -t 4 -R 12000 -L -s lua/put.lua "http://localhost:19234"`

```
Running 1m test @ http://localhost:19234
  4 threads and 64 connections
  Thread calibration: mean lat.: 2.469ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.492ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.466ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.644ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.73ms    1.12ms  19.01ms   87.51%
    Req/Sec     3.16k   323.63     5.00k    75.87%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.54ms
 75.000%    2.06ms
 90.000%    2.68ms
 99.000%    5.97ms
 99.900%   12.75ms
 99.990%   17.26ms
 99.999%   18.51ms
100.000%   19.02ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.103     0.000000            1         1.00
       0.773     0.100000        60090         1.11
       0.994     0.200000       119827         1.25
       1.180     0.300000       179751         1.43
       1.360     0.400000       239785         1.67
       1.539     0.500000       299643         2.00
       1.633     0.550000       329515         2.22
       1.729     0.600000       359552         2.50
       1.831     0.650000       389573         2.86
       1.941     0.700000       419515         3.33
       2.063     0.750000       449455         4.00
       2.133     0.775000       464614         4.44
       2.209     0.800000       479370         5.00
       2.297     0.825000       494431         5.71
       2.397     0.850000       509339         6.67
       2.519     0.875000       524177         8.00
       2.593     0.887500       531790         8.89
       2.677     0.900000       539156        10.00
       2.779     0.912500       546637        11.43
       2.911     0.925000       554097        13.33
       3.085     0.937500       561599        16.00
       3.191     0.943750       565345        17.78
       3.319     0.950000       569070        20.00
       3.479     0.956250       572822        22.86
       3.677     0.962500       576565        26.67
       3.931     0.968750       580322        32.00
       4.089     0.971875       582183        35.56
       4.263     0.975000       584048        40.00
       4.479     0.978125       585936        45.71
       4.735     0.981250       587796        53.33
       5.067     0.984375       589666        64.00
       5.259     0.985938       590598        71.11
       5.495     0.987500       591535        80.00
       5.775     0.989062       592472        91.43
       6.119     0.990625       593407       106.67
       6.579     0.992188       594350       128.00
       6.863     0.992969       594812       142.22
       7.235     0.993750       595278       160.00
       7.675     0.994531       595747       182.86
       8.263     0.995313       596217       213.33
       8.983     0.996094       596683       256.00
       9.423     0.996484       596919       284.44
       9.903     0.996875       597151       320.00
      10.407     0.997266       597385       365.71
      10.903     0.997656       597618       426.67
      11.327     0.998047       597852       512.00
      11.567     0.998242       597970       568.89
      11.855     0.998437       598088       640.00
      12.127     0.998633       598204       731.43
      12.455     0.998828       598320       853.33
      12.823     0.999023       598437      1024.00
      13.087     0.999121       598496      1137.78
      13.359     0.999219       598555      1280.00
      13.663     0.999316       598613      1462.86
      14.119     0.999414       598671      1706.67
      14.559     0.999512       598730      2048.00
      14.815     0.999561       598758      2275.56
      15.175     0.999609       598788      2560.00
      15.511     0.999658       598819      2925.71
      15.847     0.999707       598846      3413.33
      16.167     0.999756       598875      4096.00
      16.375     0.999780       598892      4551.11
      16.543     0.999805       598905      5120.00
      16.751     0.999829       598919      5851.43
      16.895     0.999854       598936      6826.67
      17.119     0.999878       598950      8192.00
      17.199     0.999890       598957      9102.22
      17.263     0.999902       598963     10240.00
      17.375     0.999915       598970     11702.86
      17.471     0.999927       598979     13653.33
      17.567     0.999939       598985     16384.00
      17.743     0.999945       598989     18204.44
      17.791     0.999951       598993     20480.00
      17.855     0.999957       598996     23405.71
      18.031     0.999963       599000     27306.67
      18.095     0.999969       599003     32768.00
      18.191     0.999973       599005     36408.89
      18.287     0.999976       599007     40960.00
      18.319     0.999979       599009     46811.43
      18.399     0.999982       599011     54613.33
        18.415     0.999985       599012     65536.00
      18.495     0.999986       599013     72817.78
      18.511     0.999988       599015     81920.00
      18.511     0.999989       599015     93622.86
      18.591     0.999991       599016    109226.67
      18.607     0.999992       599017    131072.00
      18.607     0.999993       599017    145635.56
      18.655     0.999994       599018    163840.00
      18.655     0.999995       599018    187245.71
      18.671     0.999995       599019    218453.33
      18.671     0.999996       599019    262144.00
      18.671     0.999997       599019    291271.11
      18.927     0.999997       599020    327680.00
      18.927     0.999997       599020    374491.43
      18.927     0.999998       599020    436906.67
      18.927     0.999998       599020    524288.00
      18.927     0.999998       599020    582542.22
      19.023     0.999998       599021    655360.00
      19.023     1.000000       599021          inf
#[Mean    =        1.727, StdDeviation   =        1.124]
#[Max     =       19.008, Total count    =       599021]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  716649 requests in 1.00m, 45.79MB read
Requests/sec:  11944.27
Transfer/sec:    781.51KB
```

### Get

`wrk2 -c 64 -d 60s -t 4 -R 1200 -L -s lua/get.lua "http://localhost:19234"`

```
Running 1m test @ http://localhost:19234
  4 threads and 64 connections
  Thread calibration: mean lat.: 4.920ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 4.043ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 4.007ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 4.018ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     2.05ms    1.03ms  24.96ms   84.74%
    Req/Sec   316.21    110.87     0.89k    56.10%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.90ms
 75.000%    2.40ms
 90.000%    3.01ms
 99.000%    5.04ms
 99.900%   14.44ms
 99.990%   19.09ms
 99.999%   21.44ms
100.000%   24.98ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.257     0.000000            1         1.00
       1.147     0.100000         5995         1.11
       1.390     0.200000        11988         1.25
       1.576     0.300000        18010         1.43
       1.740     0.400000        23986         1.67
       1.902     0.500000        29998         2.00
       1.985     0.550000        32982         2.22
       2.075     0.600000        35959         2.50
       2.173     0.650000        38947         2.86
       2.281     0.700000        41966         3.33
       2.405     0.750000        44951         4.00
       2.477     0.775000        46443         4.44
       2.553     0.800000        47931         5.00
       2.639     0.825000        49426         5.71
       2.745     0.850000        50940         6.67
       2.867     0.875000        52427         8.00
       2.937     0.887500        53177         8.89
       3.013     0.900000        53929        10.00
       3.103     0.912500        54665        11.43
       3.205     0.925000        55420        13.33
       3.327     0.937500        56161        16.00
       3.401     0.943750        56539        17.78
       3.483     0.950000        56907        20.00
       3.573     0.956250        57281        22.86
       3.683     0.962500        57658        26.67
       3.819     0.968750        58031        32.00
       3.905     0.971875        58217        35.56
       4.003     0.975000        58405        40.00
       4.131     0.978125        58591        45.71
       4.299     0.981250        58780        53.33
       4.483     0.984375        58969        64.00
       4.587     0.985938        59059        71.11
       4.739     0.987500        59154        80.00
       4.903     0.989062        59247        91.43
       5.139     0.990625        59340       106.67
       5.371     0.992188        59434       128.00
       5.575     0.992969        59482       142.22
       5.811     0.993750        59527       160.00
       6.215     0.994531        59575       182.86
       6.871     0.995313        59621       213.33
       7.599     0.996094        59670       256.00
       8.107     0.996484        59691       284.44
       8.823     0.996875        59715       320.00
       9.431     0.997266        59738       365.71
      10.239     0.997656        59761       426.67
      11.311     0.998047        59785       512.00
      11.783     0.998242        59796       568.89
      12.639     0.998437        59808       640.00
      13.095     0.998633        59820       731.43
      13.783     0.998828        59831       853.33
      14.591     0.999023        59843      1024.00
      14.951     0.999121        59849      1137.78
      15.223     0.999219        59856      1280.00
      16.063     0.999316        59861      1462.86
      16.543     0.999414        59866      1706.67
      16.831     0.999512        59873      2048.00
      16.863     0.999561        59875      2275.56
      17.055     0.999609        59878      2560.00
      17.215     0.999658        59881      2925.71
      17.519     0.999707        59885      3413.33
      17.727     0.999756        59887      4096.00
      17.759     0.999780        59888      4551.11
      18.287     0.999805        59890      5120.00
      18.303     0.999829        59891      5851.43
      18.511     0.999854        59893      6826.67
      18.623     0.999878        59894      8192.00
      19.087     0.999890        59895      9102.22
      19.247     0.999902        59896     10240.00
      19.247     0.999915        59896     11702.86
      19.311     0.999927        59897     13653.33
      19.343     0.999939        59898     16384.00
      19.343     0.999945        59898     18204.44
      20.863     0.999951        59899     20480.00
      20.863     0.999957        59899     23405.71
      20.863     0.999963        59899     27306.67
      21.439     0.999969        59900     32768.00
      21.439     0.999973        59900     36408.89
      21.439     0.999976        59900     40960.00
      21.439     0.999979        59900     46811.43
      21.439     0.999982        59900     54613.33
      24.975     0.999985        59901     65536.00
      24.975     1.000000        59901          inf
#[Mean    =        2.053, StdDeviation   =        1.029]
#[Max     =       24.960, Total count    =        59901]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  71980 requests in 1.00m, 4.85MB read
Requests/sec:   1199.65
Transfer/sec:     82.80KB
```

## Результаты профилирования
### GET
[Server Get CPU](html/stage3/get_cpu.html)

[Server Get alloc](html/stage3/get_alloc.html)

[Server Get lock](html/stage3/get_lock.html)
### PUT
[Server Put CPU](html/stage3/put_cpu.html)

[Server Put alloc](html/stage3/put_alloc.html)

[Server Put lock](html/stage3/put_lock.html)

## Выводы
Как мы выдим по результатам нагрузочного тестирования, после реализации шардирования производительность упала в
несколько раз. Первое, что сразу заметно это профиль локов. Теперь почти все сэмплы локов и в случае гета и в случае
пута занимает лок на неком `SelectorManager`.
Теперь рассмотрим CPU профиль вставок. 13% занимает Unsafe_Park, но как уже было сказано на занятии от него можно
избавиться правильно подобрав размер очереди и количество потоков в пулах. Еще около 13% занимает работа GC. 10%
занимает `proxyRequest`
В профилях гетов мы видим похожую ситуацию. `proxyRequest` - 8%. GC - 10%. И в сумме около 10% парков.
Итак, стабильный рейт на гетах упал почти в 2 раза, на путах - в 5 раз. Думаю на это повлияла как само проксирование
которое приносит дополнительные издержки, хотя тесты проводились по сути в рамках одного сетевого интерфеса, в
реальности даже в одной сети ситуация была бы еще хуже, не говоря уже о том что ноды могут находиться в разных ДЦ.
Еще возможно на производительность повлияла не очень качественная реализвация защиты от больной ноды.